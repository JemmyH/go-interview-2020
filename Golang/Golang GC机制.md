根：是一个有限的指针集合，程序可不经过其他对象直接访问这些指针，堆中的对象被加载时，需要先加载根中的指针。
在Go中，一般为goroutine自己的栈空间和全局栈空间。

v1.3 之前使用标记清除法
程序与对象的可达关系：能通过程序创建的对象之间的引用关系找到
1. 找到可达对象
2. STW，并将可达对象做上标记
3. 清除掉不可达对象，恢复程序运行

标记清除法的缺点：
1. STW 时间久，会让程序出现卡顿(最主要)
2. 需要扫描整个 head
3. 会产生 heap 碎片


三色标记法：
准备三个集合：白色、灰色和黑色。

程序创建之初，全部对象都为白色；
遍历所有的根节点，只遍历一层，将根节点的第一个元素加到灰色集合中；
遍历灰色集合中的所有结点，将可达的对象，标记为灰色，遍历之后的灰色，标记为黑色；
循环上一步，直到灰色集合中没有任何对象。
最后，回收所有白色集合中的对象。

三色标记法最不希望的场景：白色对象被黑色对象引用，同时另一个灰色对象与此白色对象之间的关系被破坏。造成黑色(留下)对象引用了白色(被清除)对象。
（条件1：白色被挂在黑色下 && 条件2：另一个灰色同时丢失了该白色）-----> 出现对象丢失现象
如何避免这个现象？STW！
如何在保证对象不丢失的情况下，尽可能减少 STW 的时间呢？

为了使 条件1 和 条件2 不同时出现，有 “强三色不变式” 和 “弱三色不变式”。
“强三色不变式”：破坏条件1-->强制性地不允许黑色对象不允许白色对象
“弱三色不变式”：破坏条件2-->黑色对象可以引用白色对象，但是白色对象存在其他灰色对象对它的引用，或者可达它的链路上游存在灰色对象。

这种强弱不变式，称之为“屏障机制”。
屏障？在流程执行过程中，加一些类似于钩子的额外的判断，间接地去遏制某些条件的发生。通俗的讲：就是在gc跑的过程中，可以监控对象的内存修改，并对对象进行重新标记。
在三色标记清除法中，有 “插入屏障” 和 “删除屏障” 之分。
插入屏障：当对象被引用的时候，触发的机制，满足强三色不变式；只用于堆空间。(缺点：结束时需要重新扫描一遍栈空间，短暂的 STW)
删除屏障：当对象被删除的时候，触发的机制，满足若三色不变式；栈空间和堆空间均使用。(缺点：回收精度低)

插入写屏障：当 A 对象引用 B 对象时，B 被标记为灰色。(B 如果是 A 的下游，则 B 必须被标记为灰色)

插入写屏障：满足强三色不变式(不存在黑色引用白色的情况了，因为白色会被强制变成灰色)
对于堆中的元素，默认开启插入写屏障。栈空间不启动。全部扫描之后，需要重新扫描一次栈
栈上启动插入写屏障的三色标记法：对于栈中的元素，如果在黑色对象下面引用一个白色对象，可以引用成功。在最后清理白色之后，将黑色集合中的所有结点都放到白色集合中，
重新扫描一遍所有的白色结点，启动 STW(防止外界干扰)，重新执行一遍三色标记法，新加的白色会被加到黑色集合中，停止 STW，清理白色集合中的新增对象。

不足：结束时需要启动 STW，大约 10~100 ms。

删除屏障：满足若三色不变式(满足灰色对象到白色对象的路径不会断)
被删除的对象如果为灰色或者白色，那么被标记为灰色。
不足：回收精度低，一个对象即使在回收时恰好被移除了最后一个指向的指针(这时没有对象引用它),它依旧可以活过这一轮 GC，然后再下一轮 GC 中被清除


v1.8 之后，引入混合写屏障：将插入写屏障和删除写屏障组合，满足变形的若三色不变式
满足弱三色不变式
混合写屏障+三色标记清除法：(栈没有混合写屏障，堆上有)
1. GC 开始时，所有对象默认白色；
2. 优先扫描全部栈对象，将全部可达结点设置成黑色(之后无需再进行第二次重复扫描，无需 STW)；
3. GC 期间，所有栈上新添加的对象，都被标记为黑色；
4. 在这期间堆上所有被删除的对象标记为灰色；
5. 在这期间堆上所有新加的元素被标记为灰色；
6. 继续执行三色标记法的后续步骤~

总结：
v1.1 STW
v1.3 Mark STW, Sweep 并行
v1.5，引入三色标记法，堆空间启动写屏障，栈空间不启动，全部扫描之后，需要重新扫描一遍栈空间，需要短暂的 STW；
v1.8，三色标记法+混合写屏障，堆空间启动混合写屏障，栈空间不启动，整体过程继续不需要 STW，效率很高



[https://zhuanlan.zhihu.com/p/74853110](https://zhuanlan.zhihu.com/p/74853110)

[https://www.bookstack.cn/read/For-learning-Go-Tutorial/spilt.6.src-spec-02.0.md](https://www.bookstack.cn/read/For-learning-Go-Tutorial/spilt.6.src-spec-02.0.md)

